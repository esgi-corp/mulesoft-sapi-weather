name: Deploy TAG to Prd
run-name: Deploy tag ${{ github.ref_name }} to Prd

on:
  workflow_dispatch:

jobs:
  deploy_api:
    runs-on: ubuntu-latest

    env:
      ANYPOINT_CLIENT_ID: ${{ secrets.ANYPOINT_CLIENT_ID }}
      ANYPOINT_CLIENT_SECRET: ${{ secrets.ANYPOINT_CLIENT_SECRET }}
      CONNECTEDAPP_CLIENT_ID: ${{ secrets.CONNECTEDAPP_CLIENT_ID }}
      CONNECTEDAPP_CLIENT_SECRET: ${{ secrets.CONNECTEDAPP_CLIENT_SECRET }}
      TARGET: ${{ secrets.TARGET }}
      GIT_USERNAME: ${{ secrets.GIT_USERNAME }}
      PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
      APP_NAME: "sapi-weather-app-prd"
      WORKERS: ${{ vars.WORKERS }}
      VCORES: ${{ vars.VCORES }}
      ENV: "prd"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Deploy to CloudHub 2.0
        run: |
          mvn deploy --settings .maven/settings.xml -DskipTests -DmuleDeploy \
          -Dapp.name=${APP_NAME} \
          -Denv=${ENV} \
          -Dtarget=${TARGET} \
          -Dclient.id="${CONNECTEDAPP_CLIENT_ID}" \
          -Dclient.secret="${CONNECTEDAPP_CLIENT_SECRET}" \
          -DanypointClientId=${ANYPOINT_CLIENT_ID} \
          -DanypointClientSecret=${ANYPOINT_CLIENT_SECRET} \
          -Dgit.username=${GIT_USERNAME} \
          -Dworkers=${WORKERS} \
          -Dvirtual.cores=${VCORES} \
          -Dpat.token=${PAT_TOKEN}

      - name: Check deployment success
        if: steps.deploy.outcome == 'success'
        run: echo "âœ… Deployment succeeded."

      - name: Merge deployed tag into main
        run: |
          echo "ðŸ”€ Merging tag ${{ github.ref_name }} into main..."

          # Configure Git identity 
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # RÃ©cupÃ¨re les derniÃ¨res branches et tags du remote
          git fetch origin main --depth=1
          git fetch origin "refs/tags/${{ github.ref_name }}:refs/tags/${{ github.ref_name }}"

          # CrÃ©e une nouvelle branche temporaire depuis main
          git checkout -b merge-tag-into-main origin/main

          # Merge du tag (en tant que commit standard)
          git merge "${{ github.ref_name }}" --allow-unrelated-histories -m "ðŸ”€ Merge tag ${{ github.ref_name }} into main after production deployment"

          # Push vers la branche main
          git push origin HEAD:main

          echo "âœ… Tag ${{ github.ref_name }} has been merged into main."