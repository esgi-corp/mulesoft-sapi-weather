<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:json-logger="http://www.mulesoft.org/schema/mule/json-logger"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/json-logger http://www.mulesoft.org/schema/mule/json-logger/current/mule-json-logger.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd">
	
	<!-- define soapfaultResponse variable to true at the begin of the API (before the APIKIT) if soap message and need a soapfault response -->
	<error-handler name="error-handling-apikit" doc:id="177c293e-d185-4f78-a9b6-5205fd5c0bd5" >
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="7b3d6906-6310-441b-a2b5-e79abcabb675" type="APIKIT:BAD_REQUEST">
			<ee:transform doc:name="Set HTTP Status = 400 &amp; errCode" doc:id="ca747890-c14d-468d-9d20-7bad3db48083">
				<ee:message />
				<ee:variables>
					<ee:set-variable variableName="httpStatus"><![CDATA[%dw 2.0
output application/java
---
400]]></ee:set-variable>
					<ee:set-variable variableName="errCode"><![CDATA[%dw 2.0
output application/java
---
p('error.badRequest.code')]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="error-handling:\response" doc:id="cdaa24f4-3688-476f-af8c-ca152e04f949" name="error-handling:\response" />
		
</on-error-propagate>   
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="e68450f0-a9d2-4b32-8b48-e21ac09bf475" type="APIKIT:NOT_FOUND" >
			<ee:transform doc:name="Set HTTP Status = 404 &amp; errCode" doc:id="0997c8d2-0bbe-4749-ad6f-f1393e4f995d">
				<ee:message />
				<ee:variables>
					<ee:set-variable variableName="httpStatus"><![CDATA[%dw 2.0
output application/java
---
404]]></ee:set-variable>
					<ee:set-variable variableName="errCode"><![CDATA[%dw 2.0
output application/java
---
p('error.notFound.code')]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="error-handling:\response" doc:id="dff9a800-89cb-4356-87b7-1a7b0277b2ff" name="error-handling:\response" />
		
</on-error-propagate>	
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="4982f128-1d47-4ef1-9a27-e287260e225a" type="APIKIT:METHOD_NOT_ALLOWED" >
			<ee:transform doc:name="Set HTTP Status = 405 &amp; errCode" doc:id="999b249c-ca1c-4bb0-99da-8eef82ace0ae">
				<ee:message />
				<ee:variables>
					<ee:set-variable variableName="httpStatus"><![CDATA[%dw 2.0
output application/java
---
405]]></ee:set-variable>
					<ee:set-variable variableName="errCode"><![CDATA[%dw 2.0
output application/java
---
p('error.notAllowed.code')]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="error-handling:\response" doc:id="2285461f-9103-4306-8ac8-0c657e15d023" name="error-handling:\response" />
		
</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="9523c466-c6b5-4370-bae3-c03b2fdec635" type="APIKIT:NOT_ACCEPTABLE" >
			<ee:transform doc:name="Set HTTP Status = 406 &amp; errCode" doc:id="5b9dc421-bef9-41bf-99f1-25e2562efce2">
				<ee:message />
				<ee:variables>
					<ee:set-variable variableName="httpStatus"><![CDATA[%dw 2.0
output application/java
---
406]]></ee:set-variable>
					<ee:set-variable variableName="errCode"><![CDATA[%dw 2.0
output application/java
---
p('error.notAcceptable.code')]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="error-handling:\response" doc:id="fd044381-5995-4e25-8f49-ef169d89dc6d" name="error-handling:\response" />
		
</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="3fc00269-f335-406c-a9e2-06c345665a0f" type="APIKIT:UNSUPPORTED_MEDIA_TYPE" >
			<ee:transform doc:name="Set HTTP Status = 415 &amp; errCode" doc:id="f1f65094-38d6-4117-97f5-8ed8d6d11352">
				<ee:message />
				<ee:variables>
					<ee:set-variable variableName="httpStatus"><![CDATA[%dw 2.0
output application/java
---
415]]></ee:set-variable>
					<ee:set-variable variableName="errCode"><![CDATA[%dw 2.0
output application/java
---
p('error.unsupportedMediaType.code')]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="error-handling:\response" doc:id="b048db64-fa35-43d5-9cc6-4b0a2d6f4eb2" name="error-handling:\response" />
		
</on-error-propagate>	
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="359cffcc-9761-4fe5-a4e2-cc7a421e0040" type="APIKIT:NOT_IMPLEMENTED" >
			<ee:transform doc:name="Set HTTP Status = 501 &amp; errCode" doc:id="2806c4fd-1e14-497e-8a20-e9b5160f1f73">
				<ee:message />
				<ee:variables>
					<ee:set-variable variableName="httpStatus"><![CDATA[%dw 2.0
output application/java
---
501]]></ee:set-variable>
					<ee:set-variable variableName="errCode"><![CDATA[%dw 2.0
output application/java
---
p('error.notImplemented.code')]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="error-handling:\response" doc:id="27034f92-be76-49c8-a3ef-cc1c50c721a3" name="error-handling:\response" />
		
</on-error-propagate>	
	
	</error-handler>
	
	
	<error-handler name="error-handling-app" doc:id="f30a9a5e-d97b-40c5-a03c-dca2630228a5" >
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="feb70d10-5690-492c-8492-80e07722318d" type="HTTP:NOT_FOUND">
			<ee:transform doc:name="Set HTTP Status = 404 &amp; errCode" doc:id="c2e32918-2b0d-482a-8473-a5d89f88a751" >
				<ee:message />
				<ee:variables >
					<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/java
---
404]]></ee:set-variable>
					<ee:set-variable variableName="errCode" ><![CDATA[%dw 2.0
output application/java
---
p('error.notFound.code')]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="error-handling:\response" doc:id="5b2d5296-6710-46cf-9979-7bb022083659" name="error-handling:\response" />
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="44cf76f3-46fa-4ed9-9c81-503dad471cf2" type="HTTP:UNAUTHORIZED">
			<ee:transform doc:name="Set HTTP Status = 401 &amp; errCode" doc:id="e003010c-cc5b-4d83-8b48-9f9039a38da9" >
				<ee:message />
				<ee:variables >
					<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/java
---
401]]></ee:set-variable>
					<ee:set-variable variableName="errCode" ><![CDATA[%dw 2.0
output application/java
---
p('error.notFound.code')]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="error-handling:\response" doc:id="f023fd54-88e3-4895-b70c-fddfbcc5f297" name="error-handling:\response" />
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="2a3852fb-5e23-487b-a9c6-8916536914c5" type="HTTP:UNSUPPORTED_MEDIA_TYPE">
			<ee:transform doc:name="Set HTTP Status = 415 &amp; errCode" doc:id="6df45b28-7174-4287-8de1-b9b96ddad0e9" >
				<ee:message />
				<ee:variables >
					<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/java
---
415]]></ee:set-variable>
					<ee:set-variable variableName="errCode" ><![CDATA[%dw 2.0
output application/java
---
p('error.unsupportedMediaType.code')]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="error-handling:\response" doc:id="37e7525c-c13e-4d6f-8fa4-8b0bc3d9a194" name="error-handling:\response" />
		 </on-error-propagate>

		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="b8060281-0cb8-45aa-8288-dc8d1a102534" type="HTTP:BAD_REQUEST">
			<ee:transform doc:name="Set HTTP Status = 400 &amp; errCode" doc:id="0cc9dc89-ccfc-4166-9e94-e4581d7381aa">
				<ee:message />
				<ee:variables>
					<ee:set-variable variableName="httpStatus"><![CDATA[%dw 2.0
output application/java
---
400]]></ee:set-variable>
					<ee:set-variable variableName="errCode"><![CDATA[%dw 2.0
output application/java
---
p('error.badRequest.code')]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="error-handling:\response" doc:id="d776fb43-3e1b-4ec3-8ea9-292e869b7557" name="error-handling:\response" />
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="fa065b45-95bf-4cc8-9349-63f0183cf1ce" type="HTTP:FORBIDDEN">
			<ee:transform doc:name="HTTP Status = 403 &amp; errCode" doc:id="c368484c-eb13-4a11-aef5-cf85085d24cc" >
				<ee:message />
				<ee:variables >
					<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/java
---
403]]></ee:set-variable>
					<ee:set-variable variableName="errCode" ><![CDATA[%dw 2.0
output application/java
---
p('error.badRequest.code')]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="error-handling:\response" doc:id="2e15b70a-d052-4fd2-92bd-66ab06d2cbd9" name="error-handling:\response" />
		</on-error-propagate>
		
		
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="d54f2638-a3e5-4865-a17b-28153b6ec917" type="APP:COORDINATES_NOT_FOUND">
			<ee:transform doc:name="Set HTTP Status = 404 &amp; errCode" doc:id="f43a7e30-230b-4cb9-b31a-2f5009494103">
				<ee:message />
				<ee:variables>
					<ee:set-variable variableName="httpStatus"><![CDATA[%dw 2.0
output application/java
---
404]]></ee:set-variable>
					<ee:set-variable variableName="errCode"><![CDATA[%dw 2.0
output application/java
---
p('error.notFound.code')]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="error-handling:\response" doc:id="e1cf1a08-253c-4382-abe3-fd2b73f163b6" name="error-handling:\response" />
		</on-error-propagate>
		
<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="826ae7b3-4a2c-470a-bfef-01feed488006" type="ANY">
			<choice doc:name="Choice for handling error" doc:id="aa88999b-355b-4d12-8b71-6b1eb2e78d8a" >
				<when expression="#[error.muleMessage.typedAttributes.statusCode ==422]">
					<ee:transform doc:name="Set HTTP Status = 422&amp; errCode" doc:id="0a67ad05-cd40-4953-80ad-68d0003b533b">
				<ee:message />
				<ee:variables>
					<ee:set-variable variableName="errCode"><![CDATA[%dw 2.0
output application/java
---
p('error.UnprocessableEntity.code')]]></ee:set-variable>
							<ee:set-variable variableName="httpStatus"><![CDATA[%dw 2.0
output application/java
---
422]]></ee:set-variable>
				
</ee:variables>
			</ee:transform>
					<ee:transform doc:name="Set Error Response" doc:id="94957d31-d995-4e79-8d58-02e806e1c441">
						<ee:message>
							<ee:set-payload resource="error_dwl/unprocessable-errorresponse.dwl" />
						</ee:message>
					</ee:transform>
				</when>
				<otherwise >
					<ee:transform doc:name="Set HTTP Status = 500 &amp; errCode" doc:id="a1066a6b-1fea-4257-8bb2-9a5050421774">
				<ee:message>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="errCode"><![CDATA[%dw 2.0
output application/java
---
p('error.any.code')]]></ee:set-variable>
					<ee:set-variable variableName="httpStatus"><![CDATA[%dw 2.0
output application/java
---
500]]></ee:set-variable>
							<ee:set-variable variableName="errMessage" ><![CDATA[%dw 2.0
output application/java
---
p('error.any.description')]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
					<flow-ref doc:name="error-handling:\response" doc:id="c46eee8c-b01d-47a9-bcf9-a609ab9dc53d" doc:description="error-handling:\response" name="error-handling:\response" />
				</otherwise>
			</choice>
		</on-error-propagate>
		
	
</error-handler>
	
	<sub-flow name="error-handling:\response" doc:id="8ca4735a-dfc9-42ab-be4b-149ca250c942" >
		
		<set-variable value="#[error.errorMessage.payload]" doc:name="Set errorPayload" doc:id="d768d5b3-2fd1-4291-8135-c38210c6a5ff" variableName="errorPayload" />
		<flow-ref doc:name="Default Error Response" doc:id="82341c44-655b-46c8-ba8a-24cc069e60c7" name="commonErrorFLow" />

		<!-- This flow is used when backend send native error -->
		<!-- <choice doc:name="Choice when errorPayload" doc:id="228069d1-786b-4fe1-a6c2-b72f291b8b68" >
			<when expression="#[!isEmpty(vars.errorPayload.data.errorDetails.fault)]">
				<choice doc:name="Choice when native error" doc:id="f492f47d-757e-4391-868a-2f21c06cc79a" >
					<when expression="#[isEmpty(vars.errorPayload.data.errorDetails.fault.arguments.statusCode) and isEmpty(vars.errorPayload.data.errorDetails.fault.arguments.statusMessage)]">
						<ee:transform doc:name="Native Error Response" doc:id="d6ce6588-cebe-48e1-bca5-79034863ca90">
					<ee:message>
								<ee:set-payload resource="error_dwl/native-error-response.dwl" />
					</ee:message>
				</ee:transform>
					</when>
					<otherwise >
						<flow-ref doc:name="Deafult Error Response" doc:id="5265c3de-94f4-4682-9c65-9f48bf4245ae" name="commonErrorFLow" />
					</otherwise>
				</choice>
			</when>
		</choice> -->
		
	</sub-flow>
	<sub-flow name="commonErrorFLow" doc:id="3862db44-930a-4dba-967b-1f0115636c0b" >
		<ee:transform doc:name="Set Error Response" doc:id="a53e6119-1f1f-4e88-b0aa-fdbd6e85930e" >
			<ee:message >
				<ee:set-payload resource="error_dwl/errorResponse.dwl" />
			</ee:message>
		</ee:transform>
		<ee:transform doc:name="Build Log JSON" doc:id="ef293b26-b2da-4057-aad3-f2d22c854a89" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="log_message" ><![CDATA[%dw 2.0
output application/json
---
{
  "@timestamp": now(),
  "application_name": "sapi-weather-app-" ++ p('mule.env'),
  "environment": p('mule.env'), 
  "request_uri": vars.baseUrl,
  "body_input": vars.inputRequest default null,
  "body_output": payload,
  "correlation_id": correlationId,
  "http_code": vars.httpStatus,
  "method": "GET"
 }     ]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="Send logs to platform" doc:id="2aab79b4-8bf0-44a6-83fc-f8965a5a1a57" name="log-to-elastic"/>
	</sub-flow>
	<sub-flow name="coordinates-notfound" doc:id="9325485e-2a01-4a89-a0f4-388b573a8dda" doc:description="Coordinates not found" >
		<raise-error doc:name="City not found" doc:id="c146bfc8-6fcd-40bb-8a9b-23450ad65926" doc:description="Coordinates not found" type="APP:COORDINATES_NOT_FOUND" description="Coordinates not found" />
	</sub-flow>
	

</mule>
